<!DOCTYPE html>
<!--
Â© Copyright 2012-2018 AJ Jordan
This file is part of strugee.net.
strugee.net is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.
strugee.net is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	See the
GNU Affero General Public License for more details.
You should have received a copy of the GNU Affero General Public License
along with strugee.net.	If not, see <http://www.gnu.org/licenses/>.

-->
<!-- Made and coded by AJ Jordan-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width">
    <link rel="preload" href="https://members.internetdefenseleague.org/include/?url=&amp;campaign=&amp;variant=modal">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/main.css" title="Original gray">
    <link rel="author" href="/humans.txt"><!--[if gte IE 8]> <link rel="stylesheet" href="/css/ie9.css"> <![endif]-->
    <script src="/js/main.js" defer></script>
    <title>Zero-downtime restarts have landed - strugee.net</title>
    <link rel="preconnect" href="https://webmention.io/">
    <link rel="pingback" href="https://webmention.io/strugee.net/xmlrpc">
    <link rel="webmention" href="https://webmention.io/strugee.net/webmention">
    <script src="/js/webmentions.js" defer></script>
    <!-- IndieWeb components, with <3-->
    <link rel="me" href="mailto:alex@strugee.net">
    <link rel="me" href="sms:17607054581">
    <link rel="me" href="xmpp:alex@strugee.net">
    <link rel="me" href="https://github.com/strugee">
    <link rel="me" href="https://twitter.com/strugee2">
    <link rel="me" href="https://plus.google.com/+AlexJordan">
    <link rel="me" href="https://pump.strugee.net/alex">
    <link rel="me" href="https://pod.strugee.net/people/82e1c9a030600133e0ca20474782d58c">
    <link rel="me" href="https://media.strugee.net/u/alex">
    <link rel="me" href="https://twitter.com/strugee2">
    <link rel="me" href="https://plus.google.com/+AlexJordan">
    <link rel="me" href="https://www.instagram.com/strugee2/">
    <link rel="authorization_endpoint" href="https://indieauth.com/auth">
  </head>
  <body>
    <div id="container">
      <header>
        <h1 id="topheader">strugee.net</h1>
        <nav id="navbar">
          <ul>
            <li class="navlink" id="navlabel">Nav &nbsp;::</li>
            <li class="navlink"><a href="/">Home</a></li>
            <li class="navlink"><a href="/projects/">Projects</a></li>
            <li class="navlink"><a href="/talks">Talks</a></li>
            <li class="navlink"><a href="/gpg">GPG Key</a></li>
            <li class="navlink"><a href="/contact">Contact</a></li>
            <li class="navlink"><a href="https://liberapay.com/strugee/">Tip me</a></li>
            <li class="navlink"><a href="/blog/">Blog</a></li>
          </ul>
        </nav>
      </header>
      <div id="content">
        <article class="h-entry" itemscope="itemscope" itemtype="http://schema.org/BlogPosting">
          <h1 class="p-name">Zero-downtime restarts have landed</h1>
          <p class="post-metadata">Published by <a class="p-author h-card" href="https://strugee.net/" rel="author">AJ Jordan</a> and cross-posted from <a href="http://pump.io/blog/2017/08/zero-downtime-restarts-have-landed">here</a> on 
            <time datetime="2017-08-18T02:01:16-07:00"><a href="/blog/2017/08/">August</a> 18, <a href="/blog/2017/">2017</a></time> in <a class="p-category" href="/blog/category/pump.io/">pump.io</a>
          </p>
          <div class="e-content"><p>I'm thrilled to announce that zero-downtime restarts, which I've been hacking on for the past week or two, <a href="https://github.com/pump-io/pump.io/pull/1406">have just landed</a> in pump.io master!</p>
<p>Zero-downtime restarts require at least two cluster workers and MongoDB as a Databank driver (we'll eventually relax the latter requirement as we continue to test the feature). Here's how it works:</p>
<ol>
<li>An administrator sends SIGUSR2 to the master pump.io process (note that SIGUSR1 is <a href="https://nodejs.org/api/process.html#process_signal_events">reserved by Node.js</a>)</li>
<li>The master process builds a queue of worker processes that need to be restarted</li>
<li>The master process picks a random worker from the queue and sends it a signal asking it to gracefully shut down</li>
<li>The worker process shuts down its HTTP server, which causes it to stop accepting new connections - it will do the same for the bounce server, if applicable</li>
<li>The worker shuts down its database connection once the HTTP server is completely shut down, meaning that it's done servicing in-flight requests</li>
<li>The worker closes its connection with the master process and Node.js automatically terminates due to there being no listeners on the event loop</li>
<li>The master recognizes the death of the worker process, replaces it, waits for the new worker to signal that it's listening for connections, and repeats from step 3 until the queue is empty</li>
</ol>
<p>This works because only one worker is shut down at a time, allowing the other workers to continue servicing requests while the one worker is restarted. We wait until the new worker actually signals it's ready to process requests before beginning the process for another worker.</p>
<p>Such a feature requires careful error handling, so there are a lot of built-in checks to prevent administrators from shooting themselves in the foot:</p>
<ul>
<li>If there's a restart already in progress, SIGUSR2 is ignored</li>
<li>If there's only 1 cluster worker, the restart request is refused (because there would be downtime and you should just restart the master)</li>
<li>The master process will load a magic number from the <em>new</em> code and compare it with the <em>old</em> magic number loaded when the master process started - if they don't match, SIGUSR2 will be refused. This number will be incremented for things that would make zero-downtime restarts cause problems, for example:<ul>
<li>The logic in the master process itself changing</li>
<li>Cross-process logic changing, such that a new worker communicating with old workers would cause problems</li>
<li>Database changes</li>
</ul></li>
<li>If a worker process doesn't shut itself down within 30 seconds, it will be killed</li>
<li>If a zero-downtime restart fails for any reason, the master process will refuse SIGUSR2 and will not respawn any more cluster workers, even if they crash - this is because something must have gone <em>seriously</em> wrong, either with the master, the workers, or the new code, and it's better to just restart everything. Currently this condition occurs when:<ul>
<li>A new worker died directly after being spawned (e.g. from invalid JSON in <code>pump.io.json</code>)</li>
<li>A new worker signaled that it couldn't bind to the appropriate ports</li>
</ul></li>
</ul>
<p>While these checks do a lot to catch problems, they're not a silver bullet, and we strongly recommend that administrators watch their logs as they trigger restarts. However, this is still a <em>huge</em> win for the admin experience - the most exciting part of this for me is that it's the first step we need to take towards having fully automatic updates, which has been a dream of mine for a long while now.</p>
<p>Admins running from git master can start experimenting with this feature today, and it will be released during the <em>next</em> release cycle - i.e. with the 5.1 beta and stable, <em>not</em> the current 5.0 beta. Since this is highly experimental, we want this to have as much time for testing as possible. You can also check out the <a href="https://pumpio.readthedocs.io/en/latest/administration/zero-downtime-restarts.html">official documentation</a> on this feature.</p>
<p>I hope people enjoy this! And as always, feel free to <a href="https://github.com/pump-io/pump.io/issues/new">report any bugs</a>.</p>

          </div>
        </article>
        <hr>
        <p id="webmention-replies-header">WebMention replies</p>
        <div id="webmentions"></div>
        <noscript>
          <p>Couldn't load WebMentions because you turned your JavaScript off. Sorry about that!</p>
        </noscript>
      </div>
      <footer>
        <p>You may find the source code for this website, licensed to you under the GNU Affero GPL, <a rel="license" href="https://github.com/strugee/strugee.github.com">on GitHub</a>. English copy is additionally licensed under <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons BY-SA 4.0</a>.</p>
        <p>&copy; Copyright 2012-2022 AJ Jordan.</p>
      </footer>
      <!-- Piwik-->
      <!-- Note that this Piwik instance is self-hosted and so doesn't leak metadata. Also, critically, it respects Do Not Track.-->
      <script>
        var _paq = _paq || [];
        _paq.push(['trackPageView']);
        _paq.push(['enableLinkTracking']);
        (function() {
        var u="//piwik.strugee.net/";
        _paq.push(['setTrackerUrl', u+'piwik.php']);
        _paq.push(['setSiteId', 1]);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
        })();
      </script>
      <noscript>
        <p><img src="//piwik.strugee.net/piwik.php?idsite=1" style="border:0;" alt=""></p>
      </noscript>
      <!-- End Piwik Code-->
      <div id="toys" data-turbolinks-permanent><a id="monospace-icon" href="javascript:void(0);" aria-label="Tilde button to enable monospace-style webpage display" title="Inspired by a forgotten-by-me tilde.club member who (~droob?) was &quot;making [their] life&quot; monospace.">~</a><a id="lightbulb-icon" href="javascript:void(0);" aria-label="Lightbulb button to enable dark webpage display">
          <div class="icon-lightbulb"></div></a></div>
      <script data-turbolinks-eval="false">
        window._idl = {};
        _idl.variant = "modal";
        (function() {
        	var idl = document.createElement('script');
        	idl.async = true;
        	idl.src = 'https://members.internetdefenseleague.org/include/?url=' + (_idl.url || '') + '&campaign=' + (_idl.campaign || '') + '&variant=' + (_idl.variant || 'modal');
        	document.getElementsByTagName('body')[0].appendChild(idl);
        })();
      </script>
    </div>
  </body>
</html>